<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Sri Vengamamba – Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0a0a0a;
      --panel: #1a1a1a;
      --gold: #ffd54f;
      --gold-dark: #ffb300;
      --red: #d32f2f;
      --green: #4caf50;
      --blue: #2196f3;
      --card-bg: #2a2a2a;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #1a1a1a 100%);
      color: var(--gold);
    }

    @media screen {
      body { zoom: 1.08; }
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* ===== SCROLLBAR STYLING ===== */
    .analytics-content::-webkit-scrollbar {
      width: 8px;
    }

    .analytics-content::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    .analytics-content::-webkit-scrollbar-thumb {
      background: var(--gold-dark);
      border-radius: 10px;
    }

    .analytics-content::-webkit-scrollbar-thumb:hover {
      background: var(--gold);
    }

    .analytics-header {
      flex-shrink: 0;
      text-align: center;
      padding: 16px 20px;
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
      border-bottom: 3px solid var(--gold-dark);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .analytics-header h1 {
      margin: 0;
      font-size: 32px;
      color: var(--gold);
      text-shadow: 2px 2px 8px rgba(255, 213, 79, 0.3);
      letter-spacing: 1px;
    }

    .analytics-header h3 {
      margin: 4px 0 0;
      color: #bbb;
      font-weight: 400;
      font-size: 18px;
    }

    .analytics-header .subtitle {
      margin: 2px 0 0;
      color: #888;
      font-size: 12px;
      font-style: italic;
    }

    .back-btn {
      position: absolute;
      top: 34px;
      right: 16px;
      background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 100%);
      color: #000;
      border: none;
      border-radius: 8px;
      width: auto;
      height: auto;
      cursor: pointer;
      font-size: clamp(12px, 1.5vw, 15px);
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(255, 213, 79, 0.3);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      padding: 9px 15px;
      min-width: 90px;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 213, 79, 0.5);
    }

    .back-btn:active {
      transform: scale(0.95);
    }

    .analytics-container {
      flex: 1;
      min-height: 0;
      padding: 8px;
      display: flex;
      flex-direction: column;
    }

    .analytics-content {
      flex: 1;
      min-height: 0;
      background: var(--panel);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 213, 79, 0.1);
      overflow-y: auto;
      padding: 12px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--card-bg) 0%, #333 100%);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 24px 16px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .stat-card:hover {
      border-color: rgba(255, 213, 79, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .stat-label {
      color: #999;
      font-size: 14px;
      text-transform: uppercase;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: var(--gold);
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    }

    .stat-card.total .stat-value {
      color: #4caf50;
    }

    .stat-card.count .stat-value {
      color: #2196f3;
    }

    .stat-card.avg .stat-value {
      color: #ff9800;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-container {
      background: linear-gradient(135deg, var(--card-bg) 0%, #333 100%);
      border: 1px solid rgba(255, 213, 79, 0.2);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 15px;
      text-align: center;
    }

    .chart-canvas {
      max-height: 300px;
      position: relative;
    }

    .payment-breakdown {
      background: linear-gradient(135deg, var(--card-bg) 0%, #333 100%);
      border: 1px solid rgba(255, 213, 79, 0.2);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
    }

    .payment-breakdown h3 {
      color: var(--gold);
      margin-top: 0;
      font-size: 18px;
    }

    .payment-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 213, 79, 0.1);
    }

    .payment-item:last-child {
      border-bottom: none;
    }

    .payment-method {
      color: #ccc;
      font-weight: 600;
    }

    .payment-amount {
      color: var(--gold);
      font-weight: bold;
    }

    .loading {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }

    .error-message {
      background: rgba(211, 47, 47, 0.2);
      border-left: 4px solid var(--red);
      color: #ff6b6b;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .report-section {
      background: linear-gradient(135deg, var(--card-bg) 0%, #333 100%);
      border: 1px solid rgba(255, 213, 79, 0.2);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
    }

    .report-section h3 {
      color: var(--gold);
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 20px;
      border-bottom: 2px solid var(--gold-dark);
      padding-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .toggle-hidden-btn {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      transition: all 0.3s ease;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toggle-hidden-btn:hover {
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(33, 150, 243, 0.4);
    }

    .toggle-hidden-btn:disabled {
      background: linear-gradient(135deg, #555 0%, #444 100%);
      cursor: not-allowed;
      opacity: 0.5;
      box-shadow: none;
      transform: none;
    }

    .toggle-hidden-btn.active {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }

    .report-table thead {
      background: rgba(0, 0, 0, 0.4);
      border-bottom: 2px solid var(--gold-dark);
    }

    .report-table th {
      padding: 14px 12px;
      text-align: left;
      color: var(--gold);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      border-right: 1px solid rgba(255, 213, 79, 0.1);
    }

    .report-table th:hover {
      background: rgba(255, 213, 79, 0.1);
    }

    .report-table th:last-child {
      border-right: none;
    }

    .report-table td {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 213, 79, 0.1);
      color: #ccc;
    }

    .report-table tbody tr:hover {
      background: rgba(255, 213, 79, 0.05);
    }

    .amount-cell {
      color: var(--gold);
      font-weight: bold;
      text-align: right;
    }

    .qty-cell {
      text-align: center;
      color: #2196f3;
      font-weight: 600;
    }

    .event-cell {
      color: #ff9800;
    }

    .bill-no-cell {
      color: #4caf50;
      font-weight: 600;
    }

    .report-total {
      background: rgba(0, 0, 0, 0.3);
      font-weight: bold;
      border-top: 2px solid var(--gold-dark);
      color: var(--gold);
    }

    .no-data {
      text-align: center;
      padding: 20px;
      color: #999;
      font-style: italic;
    }

    .sort-indicator {
      display: inline-block;
      margin-left: 5px;
      font-size: 10px;
    }

    .date-picker-panel {
      flex-shrink: 0;
      background: rgba(0, 0, 0, 0.3);
      padding: 12px;
      border-radius: 12px 12px 0 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: stretch;
      border-bottom: 1px solid rgba(255, 213, 79, 0.1);
    }

    .date-controls,
    .range-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .date-btn {
      background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      transition: all 0.3s ease;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      height: 42px;
      display: flex;
      align-items: center;
    }

    .date-btn:hover {
      background: linear-gradient(135deg, #b71c1c 0%, #a01818 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
    }

    .date-btn:active {
      transform: scale(0.97);
    }

    .date-btn.active {
      background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 100%);
      color: #000;
      box-shadow: 0 4px 12px rgba(255, 213, 79, 0.4);
    }

    .date-display {
      color: #999;
      font-size: 12px;
      font-weight: 600;
      margin-left: auto;
    }

    .calendar-picker-wrapper {
      display: flex;
      gap: 0;
      align-items: center;
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      border: 1px solid rgba(255, 213, 79, 0.3);
      border-radius: 6px;
      padding: 0;
      height: 36px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .calendar-label {
      color: var(--gold);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      white-space: nowrap;
      letter-spacing: 0.3px;
      padding: 0 12px;
      background: rgba(0, 0, 0, 0.3);
      height: 100%;
      display: flex;
      align-items: center;
      border-right: 1px solid rgba(255, 213, 79, 0.2);
    }

    .calendar-icon {
      width: 32px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 1px solid rgba(255, 213, 79, 0.2);
      background: rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .calendar-icon::before {
      content: "";
      width: 16px;
      height: 16px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffd54f' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'/%3E%3Cline x1='16' y1='2' x2='16' y2='6'/%3E%3Cline x1='8' y1='2' x2='8' y2='6'/%3E%3Cline x1='3' y1='10' x2='21' y2='10'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
      display: block;
    }

    .custom-date-input {
      padding: 0 12px;
      border: none;
      border-radius: 0;
      background: transparent;
      color: #fff;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      min-width: 130px;
      height: 100%;
      transition: all 0.3s ease;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .calendar-picker-wrapper:hover {
      border-color: var(--gold-dark);
      box-shadow: 0 4px 12px rgba(255, 213, 79, 0.2);
    }

    .custom-date-input:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .custom-date-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.08);
    }

    /* Calendar icon styling */
    .custom-date-input::-webkit-calendar-picker-indicator {
      cursor: pointer;
      filter: invert(1) brightness(1.2);
      opacity: 1;
      padding: 4px 6px;
      margin-right: 6px;
      width: 20px;
      height: 20px;
    }

    .custom-date-input::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
      filter: invert(1) brightness(1.4);
      transform: scale(1.1);
    }

    .search-panel {
      background: linear-gradient(135deg, var(--card-bg) 0%, #333 100%);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 213, 79, 0.2);
    }

    .category-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      background: linear-gradient(135deg, var(--card-bg) 0%, #333 100%);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 213, 79, 0.2);
    }

    .category-tab {
      background: rgba(0, 0, 0, 0.5);
      color: #ccc;
      border: 1px solid rgba(255, 213, 79, 0.2);
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s ease;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .category-tab:hover {
      border-color: var(--gold-dark);
      background: rgba(255, 213, 79, 0.1);
    }

    .category-tab.active {
      background: linear-gradient(135deg, var(--gold-dark) 0%, var(--gold) 100%);
      color: #000;
      border-color: var(--gold);
      box-shadow: 0 4px 12px rgba(255, 213, 79, 0.3);
    }

    .category-analysis {
      background: linear-gradient(135deg, var(--card-bg) 0%, #333 100%);
      border: 1px solid rgba(255, 213, 79, 0.2);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--gold-dark);
    }

    .category-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .category-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .category-stat {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 213, 79, 0.1);
      border-radius: 8px;
      padding: 15px 12px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .category-stat:hover {
      border-color: rgba(255, 213, 79, 0.3);
      background: rgba(255, 213, 79, 0.05);
    }

    .category-stat-label {
      font-size: 11px;
      color: #999;
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: 0.4px;
    }

    .category-stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--gold);
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .category-items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .category-item-card {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 213, 79, 0.1);
      border-radius: 8px;
      padding: 14px;
      transition: all 0.3s ease;
    }

    .category-item-card:hover {
      border-color: rgba(255, 213, 79, 0.3);
      background: rgba(255, 213, 79, 0.05);
    }

    .item-card-name {
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .item-card-details {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .item-card-detail {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #ccc;
    }

    .item-card-detail strong {
      color: var(--gold);
      font-weight: 700;
    }

    .search-input {
      width: 100%;
      padding: 14px 18px;
      border: 1px solid var(--gold-dark);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: var(--gold);
      font-size: 16px;
      min-height: 44px;
    }

    .search-input::placeholder {
      color: rgba(255, 213, 79, 0.5);
    }

    .search-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(255, 213, 79, 0.3);
    }

    .action-btn {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      white-space: nowrap;
      min-height: 36px;
      display: flex;
      align-items: center;
    }

    .action-btn:hover {
      background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%);
      transform: scale(1.05);
    }

    .action-btn.hide-btn {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    }

    .action-btn.hide-btn:hover {
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
    }

    .action-btn.unhide-btn {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    }

    .action-btn.unhide-btn:hover {
      background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
    }

    .hidden-bill-row {
      opacity: 0.5;
      background: rgba(255, 152, 0, 0.05);
    }

    .delete-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .delete-modal.active {
      display: flex;
      line-height: 1.5;
    }

    .modal-warning {
      background: rgba(211, 47, 47, 0.1);
      border-left: 3px solid #d32f2f;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 12px;
      color: #d32f2f;
    }

    .delete-modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .delete-modal-content h3 {
      color: #000;
      margin: 0 0 12px;
      font-size: 20px;
    }

    .delete-modal-content p {
      color: #555;
      margin: 0 0 20px;
      font-size: 14px;
    }

    .delete-modal-actions {
      display: flex;
      gap: 10px;
    }

    .delete-modal-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .delete-confirm-btn {
      background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
      color: white;
    }

    .delete-confirm-btn:hover {
      background: linear-gradient(135deg, #b71c1c 0%, #a01818 100%);
      transform: translateY(-2px);
    }

    .permanent-delete-btn {
      background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
      color: var(--gold);
      border: 2px solid #d32f2f;
    }

    .permanent-delete-btn:hover {
      background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
      color: white;
      border-color: #d32f2f;
    }

    .delete-cancel-btn {
      background: #e0e0e0;
      color: #333;
    }

    .delete-cancel-btn:hover {
      background: #d0d0d0;
    }

    /* ===== PAGE FOOTER ===== */
    .page-footer {
      flex-shrink: 0;
      text-align: center;
      font-size: 13px;
      color: #999;
      border-top: 2px solid rgba(255, 213, 79, 0.2);
      padding: 12px;
      background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%);
      margin-top: auto;
    }

    .page-footer b {
      color: var(--gold);
      font-weight: 700;
    }

    .action-buttons-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin: 18px 0;
    }

    .action-mode-btn {
      background: linear-gradient(135deg, #37474f 0%, #455a64 100%);
      color: white;
      border: 2px solid transparent;
      padding: 14px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-mode-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 213, 79, 0.3);
    }

    .action-mode-btn.hide-mode {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    }

    .action-mode-btn.hide-mode:hover {
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
    }

    .action-mode-btn.unhide-mode {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    }

    .action-mode-btn.unhide-mode:hover {
      background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
    }

    .action-mode-btn.delete-mode {
      background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
    }

    .action-mode-btn.delete-mode:hover {
      background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
    }

    @media (max-width: 768px) {
      body {
        zoom: 1;
      }

      .analytics-container {
        padding: 10px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .analytics-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
        padding-bottom: 12px;
      }

      .analytics-header h1 {
        font-size: 22px;
      }

      .back-btn {
        position: static;
        margin: 6px auto 0;
        padding: 8px 14px;
        min-width: 120px;
        font-size: 12px;
      }

      .date-controls,
      .range-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .date-btn {
        width: 100%;
        justify-content: center;
      }

      .calendar-picker-wrapper {
        width: 100%;
      }

      .custom-date-input {
        min-width: 0;
        width: 100%;
      }

      .date-display {
        margin-left: 0;
        width: 100%;
        text-align: center;
      }

      .report-section {
        padding: 16px;
        overflow-x: auto;
      }

      .report-section h3 {
        flex-wrap: wrap;
        gap: 10px;
      }

      .report-table {
        min-width: 680px;
      }

      .action-buttons-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      body {
        zoom: 1;
      }

      .back-btn {
        width: 100%;
        max-width: 220px;
        padding: 10px 14px;
        min-height: 44px;
        font-size: 12px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .chart-container {
        padding: 14px;
      }

      .chart-title {
        font-size: 16px;
      }

      .report-table {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>

<div class="analytics-header">
  <h1>Sri Vengamamba Food Court</h1>
  <h3>Chinese Kitchen / Juice Bar - Billing Portal</h3>
  <div class="subtitle">Analytics Dashboard</div>
  <button class="back-btn" onclick="window.location.href='/'">←</button>
</div>

<div class="analytics-container">
  <div id="loadingMessage" class="loading">Loading analytics data...</div>
  
  <div id="analyticsContent" class="analytics-content" style="display: none;">
    <div class="date-picker-panel">
      <div class="date-controls">
        <button class="date-btn active" onclick="setAnalyticsDate('today')" id="btn-today">TODAY</button>
        <button class="date-btn" onclick="setAnalyticsDate('week')" id="btn-week">THIS WEEK</button>
        <button class="date-btn" onclick="setAnalyticsDate('month')" id="btn-month">THIS MONTH</button>
        <div class="calendar-picker-wrapper">
          <span class="calendar-icon" aria-hidden="true"></span>
          <input type="date" id="customDate" class="custom-date-input" placeholder="Pick a date" onchange="setAnalyticsDate('custom')" style="padding-right: 30px;">
        </div>
        <span id="dateDisplay" class="date-display">Today</span>
      </div>
      <div class="range-controls">
        <div class="calendar-picker-wrapper">
          <label for="rangeFrom" class="calendar-label">FROM:</label>
          <input type="date" id="rangeFrom" class="custom-date-input" style="padding-right: 30px;">
        </div>
        <div class="calendar-picker-wrapper">
          <label for="rangeTo" class="calendar-label">TO:</label>
          <input type="date" id="rangeTo" class="custom-date-input" style="padding-right: 30px;">
        </div>
        <button class="date-btn" id="btn-range" onclick="applyRangeFilter()">APPLY RANGE</button>
      </div>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card total">
        <div class="stat-label">Total Sales (Today)</div>
        <div class="stat-value">₹<span id="totalSales">0</span></div>
      </div>
      <div class="stat-card count">
        <div class="stat-label">Total Bills (Today)</div>
        <div class="stat-value"><span id="billCount">0</span></div>
      </div>
      <div class="stat-card avg">
        <div class="stat-label">Average Bill</div>
        <div class="stat-value">₹<span id="avgBill">0</span></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Peak Hour</div>
        <div class="stat-value"><span id="peakHour">N/A</span></div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card total">
        <div class="stat-label">This Week Sales</div>
        <div class="stat-value">₹<span id="weekSales">0</span></div>
      </div>
      <div class="stat-card count">
        <div class="stat-label">This Week Bills</div>
        <div class="stat-value"><span id="weekBillCount">0</span></div>
      </div>
      <div class="stat-card avg">
        <div class="stat-label">This Month Sales</div>
        <div class="stat-value">₹<span id="monthSales">0</span></div>
      </div>
      <div class="stat-card count">
        <div class="stat-label">This Month Bills</div>
        <div class="stat-value"><span id="monthBillCount">0</span></div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">Sales Trend (Last 7 Days)</div>
        <div class="chart-canvas">
          <canvas id="salesChart"></canvas>
        </div>
      </div>
      <div class="chart-container">
        <div class="chart-title">Top Items</div>
        <div class="chart-canvas">
          <canvas id="itemsChart"></canvas>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <div class="chart-title">Payment Methods</div>
        <div class="chart-canvas">
          <canvas id="paymentChart"></canvas>
        </div>
      </div>
    </div>

    <div class="payment-breakdown">
      <h3>Payment Breakdown (Today)</h3>
      <div id="paymentBreakdown"></div>
    </div>

    <!-- CATEGORY ANALYSIS SECTION -->
    <div class="report-section">
      <h3>Category Analysis</h3>
      <div class="category-tabs" id="categoryTabs">
        <button class="category-tab active" onclick="selectCategory('all')" data-category="all">All Categories</button>
      </div>
    </div>

    <div id="categoryAnalysisContainer" class="category-analysis" style="display: none;">
      <div class="category-header">
        <div class="category-title" id="categoryTitle">All Categories</div>
        <div style="color: #999; font-size: 13px;" id="categoryItemCount">0 items sold</div>
      </div>

      <div class="category-stats-grid">
        <div class="category-stat">
          <div class="category-stat-label">Category Revenue</div>
          <div class="category-stat-value">₹<span id="catRevenue">0</span></div>
        </div>
        <div class="category-stat">
          <div class="category-stat-label">Items Sold</div>
          <div class="category-stat-value"><span id="catItemCount">0</span></div>
        </div>
        <div class="category-stat">
          <div class="category-stat-label">Avg Per Item</div>
          <div class="category-stat-value">₹<span id="catAvgPrice">0</span></div>
        </div>
        <div class="category-stat">
          <div class="category-stat-label">Bill Count</div>
          <div class="category-stat-value"><span id="catBillCount">0</span></div>
        </div>
      </div>

      <div id="categoryChartContainer" style="margin-bottom: 20px; display: none;">
        <div class="chart-container">
          <div class="chart-title" id="categoryChartTitle">Category Breakdown</div>
          <div class="chart-canvas">
            <canvas id="categoryDetailChart"></canvas>
          </div>
        </div>
      </div>

      <div id="categoryItemsGrid" class="category-items-grid"></div>
    </div>

    <div class="report-section">
      <h3>Item Sales Summary</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th onclick="sortReport('items', 'name')">Item Name <span class="sort-indicator" id="items-name-sort"></span></th>
            <th onclick="sortReport('items', 'qty')">Qty <span class="sort-indicator" id="items-qty-sort"></span></th>
            <th onclick="sortReport('items', 'total')">Total (₹) <span class="sort-indicator" id="items-total-sort"></span></th>
          </tr>
        </thead>
        <tbody id="itemsReportBody">
          <tr><td colspan="3" class="no-data">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="report-section">
      <h3>Order Type Analysis</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th onclick="sortReport('events', 'type')">Order Type <span class="sort-indicator" id="events-type-sort"></span></th>
            <th onclick="sortReport('events', 'count')">Bill Count <span class="sort-indicator" id="events-count-sort"></span></th>
            <th onclick="sortReport('events', 'total')">Total (₹) <span class="sort-indicator" id="events-total-sort"></span></th>
          </tr>
        </thead>
        <tbody id="eventsReportBody">
          <tr><td colspan="3" class="no-data">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="report-section">
      <h3 style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
        <span>Complete Bill Register <span id="billPageInfo" style="font-size: 14px; font-weight: 400; color: #999;"></span></span>
        <div style="display: flex; gap: 8px; align-items: center;">
          <button class="toggle-hidden-btn" id="prevBillPageBtn" onclick="changeBillPage(-1)" style="min-width: 40px; padding: 8px 10px;" title="Previous Page">◀</button>
          <button class="toggle-hidden-btn" id="nextBillPageBtn" onclick="changeBillPage(1)" style="min-width: 40px; padding: 8px 10px;" title="Next Page">▶</button>
          <button class="toggle-hidden-btn" id="billActionsBtn" onclick="openBillActionsModal()" style="min-width: 120px;">Manage Bills</button>
        </div>
      </h3>
      <div class="search-panel">
        <input type="text" id="billSearch" class="search-input" placeholder="Search by Bill No, Payment Method, or Order Type...">
      </div>
      <table class="report-table">
        <thead>
          <tr>
            <th onclick="sortReport('bills', 'token')">Bill No <span class="sort-indicator" id="bills-token-sort">▼</span></th>
            <th onclick="sortReport('bills', 'date')">Date & Time <span class="sort-indicator" id="bills-date-sort"></span></th>
            <th onclick="sortReport('bills', 'orderType')">Order Type <span class="sort-indicator" id="bills-orderType-sort"></span></th>
            <th onclick="sortReport('bills', 'items')">Items <span class="sort-indicator" id="bills-items-sort"></span></th>
            <th onclick="sortReport('bills', 'total')">Amount <span class="sort-indicator" id="bills-total-sort"></span></th>
            <th onclick="sortReport('bills', 'payment')">Payment <span class="sort-indicator" id="bills-payment-sort"></span></th>
          </tr>
        </thead>
        <tbody id="billsReportBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Bill Actions Modal -->
<div class="delete-modal" id="billActionsModal">
  <div class="delete-modal-content" style="max-width: 380px; background: linear-gradient(135deg, rgba(10,10,10,0.95) 0%, rgba(20,20,20,0.95) 100%);">
    <h3 style="color: #ffd54f; margin-bottom: 8px;">Bill Actions</h3>
    <p style="margin: 0 0 20px 0; font-size: 13px; color: #999;">Select an action to perform on bills:</p>
    <div class="action-buttons-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px;">
      <button class="action-mode-btn hide-mode" onclick="switchActionMode('hide')" style="padding: 12px 16px; font-size: 13px; font-weight: 600; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);">Hide Bill</button>
      <button class="action-mode-btn unhide-mode" onclick="switchActionMode('unhide')" style="padding: 12px 16px; font-size: 13px; font-weight: 600; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);">Unhide Bill</button>
      <button class="action-mode-btn delete-mode" onclick="switchActionMode('delete')" style="padding: 12px 16px; font-size: 13px; font-weight: 600; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%); color: white; box-shadow: 0 2px 6px rgba(211, 47, 47, 0.3);">Delete Bill</button>
    </div>
    
    <div id="actionModeContent" style="margin-top: 0; display: none; background: rgba(0,0,0,0.4); padding: 18px; border-radius: 6px; border-left: 4px solid #ffd54f;">
      <label style="color: #ffd54f; font-weight: 700; font-size: 11px; text-transform: uppercase; display: block; margin-bottom: 12px; letter-spacing: 0.5px;">Select Bill</label>
      <select id="billSelector" class="bill-select" style="width: 100%; padding: 12px 12px; border: 1px solid rgba(255,213,79,0.3); background: rgba(0,0,0,0.5); color: white; border-radius: 4px; font-size: 13px; margin-bottom: 14px; font-weight: 500;">
        <option value="">-- Select a bill --</option>
      </select>
      <p id="actionWarning" style="margin: 12px 0 0 0; padding: 12px; background: rgba(211, 47, 47, 0.15); border-left: 3px solid #d32f2f; color: #ff9999; font-size: 12px; display: none; border-radius: 3px;"></p>
      <div class="delete-modal-actions" style="margin-top: 18px; display: flex; gap: 10px;">
        <button class="delete-cancel-btn" onclick="closeBillActionsModal()" style="flex: 1; padding: 10px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ccc; border-radius: 4px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">Cancel</button>
        <button class="delete-confirm-btn" id="confirmActionBtn" onclick="confirmBillAction()" style="flex: 1; padding: 10px 16px; background: linear-gradient(135deg, #ffd54f 0%, #ffb300 100%); border: none; color: #000; border-radius: 4px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; font-size: 13px;">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Permanent Delete Modal -->
<div class="delete-modal" id="permanentDeleteModal">
  <div class="delete-modal-content">
    <h3>⚠️ Permanent Delete</h3>
    <p>Are you sure you want to <strong>permanently delete</strong> bill <strong id="permDeleteBillNumber"></strong>?</p>
    <div class="modal-warning">
      This action cannot be undone. The bill will be completely removed from the database.
    </div>
    <div class="delete-modal-actions">
      <button class="delete-cancel-btn" onclick="cancelPermanentDelete()">Cancel</button>
      <button class="permanent-delete-btn" onclick="confirmPermanentDelete()">Permanently Delete</button>
    </div>
  </div>
</div>

<script>
// Connect to Render backend
const apiUrl = (path) => 'https://svfc-ckfb-bp-backend.onrender.com' + path;
let chartInstances = {};
let reportData = {
  items: [],
  events: [],
  bills: []
};
let sortStates = {
  items: { field: 'total', order: 'desc' },
  events: { field: 'total', order: 'desc' },
  bills: { field: 'token', order: 'desc' }
};
let showingHiddenBills = false;
let allBillsData = [];
let currentBillPage = 1;
let billsPerPage = 50;

function parseBillDate(bill) {
  const rawDate = bill.createdAtISO || bill.createdAt || bill.date || null;
  if (!rawDate) return null;
  if (typeof rawDate === 'string') {
    const hasTimezone = /[zZ]|[+-]\d{2}:?\d{2}$/.test(rawDate);
    const normalized = hasTimezone ? rawDate : `${rawDate}Z`;
    const parsed = new Date(normalized);
    return isNaN(parsed.getTime()) ? null : parsed;
  }
  const parsed = new Date(rawDate);
  return isNaN(parsed.getTime()) ? null : parsed;
}

async function loadAnalytics() {
  try {
    const response = await fetch(apiUrl('/api/bills?includeDeleted=true'));
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const text = await response.text();
    if (!text) {
      document.getElementById('analyticsContent').style.display = 'block';
      document.getElementById('loadingMessage').style.display = 'none';
      return;
    }
    
    let bills = [];
    try {
      bills = JSON.parse(text);
    } catch (parseError) {
      document.getElementById('loadingMessage').innerHTML = '<div class="error-message">Unable to load analytics data</div>';
      return;
    }
    
    if (!bills || bills.length === 0) {
      document.getElementById('analyticsContent').style.display = 'block';
      document.getElementById('loadingMessage').style.display = 'none';
      return;
    }

    // Preserve full dataset for downloads
    allBillsData = bills;

    // Separate active and deleted bills
    const activeBills = bills.filter(bill => !bill.deleted);
    const deletedBills = bills.filter(bill => bill.deleted);

    // Get today, this week, and this month
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay());
    
    const monthStart = new Date(today);
    monthStart.setDate(1);
    
    // Apply date filtering based on selected date mode
    let filterBills = activeBills;
    if (dateMode === 'today') {
      filterBills = filterBills.filter(bill => {
        const billDate = parseBillDate(bill);
        if (!billDate) return false;
        billDate.setHours(0, 0, 0, 0);
        return billDate.getTime() === today.getTime();
      });
    } else if (dateMode === 'week') {
      filterBills = filterBills.filter(bill => {
        const billDate = parseBillDate(bill);
        if (!billDate) return false;
        billDate.setHours(0, 0, 0, 0);
        return billDate.getTime() >= weekStart.getTime();
      });
    } else if (dateMode === 'month') {
      filterBills = filterBills.filter(bill => {
        const billDate = parseBillDate(bill);
        if (!billDate) return false;
        billDate.setHours(0, 0, 0, 0);
        return billDate.getTime() >= monthStart.getTime();
      });
    } else if (dateMode === 'custom' && selectedDate) {
      const customDate = new Date(selectedDate);
      customDate.setHours(0, 0, 0, 0);
      filterBills = filterBills.filter(bill => {
        const billDate = parseBillDate(bill);
        if (!billDate) return false;
        billDate.setHours(0, 0, 0, 0);
        return billDate.getTime() === customDate.getTime();
      });
    } else if (dateMode === 'range' && rangeFromDate && rangeToDate) {
      const rangeFrom = new Date(rangeFromDate);
      const rangeTo = new Date(rangeToDate);
      filterBills = filterBills.filter(bill => {
        const billDate = parseBillDate(bill);
        if (!billDate) return false;
        return billDate >= rangeFrom && billDate <= rangeTo;
      });
    }
    
    const todayBills = filterBills;

    const weekBills = activeBills.filter(bill => {
      const billDate = parseBillDate(bill);
      if (!billDate) return false;
      billDate.setHours(0, 0, 0, 0);
      return billDate.getTime() >= weekStart.getTime();
    });

    const monthBills = activeBills.filter(bill => {
      const billDate = parseBillDate(bill);
      if (!billDate) return false;
      billDate.setHours(0, 0, 0, 0);
      return billDate.getTime() >= monthStart.getTime();
    });

    // Calculate stats
    const totalSales = todayBills.reduce((sum, bill) => sum + (bill.total || 0), 0);
    const avgBill = todayBills.length > 0 ? Math.round(totalSales / todayBills.length) : 0;

    document.getElementById('totalSales').textContent = totalSales.toLocaleString('en-IN');
    document.getElementById('billCount').textContent = todayBills.length;
    document.getElementById('avgBill').textContent = avgBill.toLocaleString('en-IN');

    // Week stats
    const weekSales = weekBills.reduce((sum, bill) => sum + (bill.total || 0), 0);
    document.getElementById('weekSales').textContent = weekSales.toLocaleString('en-IN');
    document.getElementById('weekBillCount').textContent = weekBills.length;

    // Month stats
    const monthSales = monthBills.reduce((sum, bill) => sum + (bill.total || 0), 0);
    document.getElementById('monthSales').textContent = monthSales.toLocaleString('en-IN');
    document.getElementById('monthBillCount').textContent = monthBills.length;

    // Calculate peak hour
    const hourCounts = {};
    todayBills.forEach(bill => {
      const billDate = parseBillDate(bill);
      if (!billDate) return;
      const hour = billDate.getHours();
      hourCounts[hour] = (hourCounts[hour] || 0) + 1;
    });
    const peakHour = Object.entries(hourCounts).reduce((a, b) => a[1] > b[1] ? a : b, [0, 0])[0];
    document.getElementById('peakHour').textContent = peakHour.toString().padStart(2, '0') + ':00';

    // Payment breakdown
    const paymentMethods = {};
    todayBills.forEach(bill => {
      const method = bill.payment || 'Unknown';
      paymentMethods[method] = (paymentMethods[method] || 0) + (bill.total || 0);
    });

    let paymentHTML = '';
    Object.entries(paymentMethods).forEach(([method, amount]) => {
      paymentHTML += `
        <div class="payment-item">
          <span class="payment-method">${method}</span>
          <span class="payment-amount">₹${amount.toLocaleString('en-IN')}</span>
        </div>
      `;
    });
    document.getElementById('paymentBreakdown').innerHTML = paymentHTML;

    // Top items
    const itemCounts = {};
    const itemTotals = {};
    todayBills.forEach(bill => {
      if (bill.items && Array.isArray(bill.items)) {
        bill.items.forEach(item => {
          const itemTotal = (item.price || 0) * (item.qty || 1);
          itemCounts[item.name] = (itemCounts[item.name] || 0) + (item.qty || 1);
          itemTotals[item.name] = (itemTotals[item.name] || 0) + itemTotal;
        });
      }
    });

    // Build items report data
    reportData.items = Object.entries(itemCounts).map(([name, qty]) => ({
      name,
      qty,
      total: itemTotals[name] || 0
    }));

    // Build events report data
    const eventCounts = {};
    const eventTotals = {};
    todayBills.forEach(bill => {
      const type = bill.orderType || 'Unknown';
      eventCounts[type] = (eventCounts[type] || 0) + 1;
      eventTotals[type] = (eventTotals[type] || 0) + (bill.total || 0);
    });

    reportData.events = Object.entries(eventCounts).map(([type, count]) => ({
      type,
      count,
      total: eventTotals[type] || 0
    }));

    // Build bills report data
    reportData.bills = todayBills.map((bill, index) => {
      const billDate = parseBillDate(bill);
      const dateStr = bill.createdAtISO || bill.createdAt;
      const formattedDate = billDate.toLocaleString('en-IN', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true
      });
      
      return {
        token: bill.token || bill.billNo || (index + 1),
        date: formattedDate,
        rawDate: dateStr,
        orderType: bill.orderType || 'Dine-in / Take Out',
        items: bill.items ? bill.items.length : 0,
        total: bill.total || 0,
        payment: bill.payment || 'Unknown',
        deleted: bill.deleted || false,
        createdAt: dateStr
      };
    });

    // Reset to first page when data changes
    currentBillPage = 1;

    // Default sort: latest bill first, keep stable until user changes
    applySortAndRender('bills');
    applySortAndRender('items');
    applySortAndRender('events');

    // Chart: Top Items
    const topItems = Object.entries(itemCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);

    if (topItems.length > 0) {
      createChart('itemsChart', 'bar', {
        labels: topItems.map(([name]) => name),
        datasets: [{
          label: 'Orders',
          data: topItems.map(([, count]) => count),
          backgroundColor: 'rgba(255, 213, 79, 0.7)',
          borderColor: 'rgba(255, 179, 0, 1)',
          borderWidth: 2
        }]
      }, {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        }
      });
    }

    // Chart: Payment Methods
    if (Object.keys(paymentMethods).length > 0) {
      createChart('paymentChart', 'doughnut', {
        labels: Object.keys(paymentMethods),
        datasets: [{
          data: Object.values(paymentMethods),
          backgroundColor: [
            'rgba(255, 213, 79, 0.8)',
            'rgba(76, 175, 80, 0.8)',
            'rgba(33, 150, 243, 0.8)',
            'rgba(211, 47, 47, 0.8)',
            'rgba(255, 152, 0, 0.8)'
          ],
          borderColor: [
            'rgba(255, 179, 0, 1)',
            'rgba(56, 142, 60, 1)',
            'rgba(13, 110, 253, 1)',
            'rgba(168, 27, 27, 1)',
            'rgba(230, 124, 0, 1)'
          ],
          borderWidth: 2
        }]
      }, {
        responsive: true,
        maintainAspectRatio: false
      });
    }

    // Sales trend (last 7 days)
    const last7Days = [];
    const salesData = [];
    for (let i = 6; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dayBills = activeBills.filter(bill => {
        const billDate = new Date(bill.createdAt);
        billDate.setHours(0, 0, 0, 0);
        return billDate.getTime() === date.getTime();
      });
      const dayTotal = dayBills.reduce((sum, bill) => sum + (bill.total || 0), 0);
      last7Days.push(date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
      salesData.push(dayTotal);
    }

    createChart('salesChart', 'line', {
      labels: last7Days,
      datasets: [{
        label: 'Sales (₹)',
        data: salesData,
        borderColor: 'rgba(255, 213, 79, 1)',
        backgroundColor: 'rgba(255, 213, 79, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: 'rgba(255, 213, 79, 1)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5
      }]
    }, {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true }
      }
    });

    document.getElementById('loadingMessage').style.display = 'none';
    document.getElementById('analyticsContent').style.display = 'block';
    
    // Initialize category analysis
    buildCategoryTabs();
    selectCategory('all');
  } catch (error) {
    document.getElementById('loadingMessage').innerHTML = `<div class="error-message">Error loading data: ${error.message}</div>`;
  }
}

function applySortAndRender(reportType) {
  const state = sortStates[reportType];
  const data = reportData[reportType];
  const field = state.field;

  data.sort((a, b) => {
    let aVal = a[field];
    let bVal = b[field];

    // Special handling for date field - use rawDate for comparison
    if (field === 'date' && a.rawDate && b.rawDate) {
      aVal = a.rawDate;
      bVal = b.rawDate;
    }

    if (typeof aVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
      return state.order === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
    }
    return state.order === 'asc' ? aVal - bVal : bVal - aVal;
  });

  document.querySelectorAll(`#${reportType}-${field}-sort`).forEach(el => {
    el.textContent = state.order === 'asc' ? '▲' : '▼';
  });
  document.querySelectorAll(`.sort-indicator`).forEach(el => {
    if (!el.textContent.includes('▲') && !el.textContent.includes('▼')) {
      el.textContent = '';
    }
  });

  // Reset to first page when sorting bills
  if (reportType === 'bills') {
    currentBillPage = 1;
  }

  renderReport(reportType);
}

function setReportSort(reportType, field, order) {
  const state = sortStates[reportType];
  state.field = field;
  state.order = order;
  applySortAndRender(reportType);
}

function sortReport(reportType, field) {
  const state = sortStates[reportType];

  if (state.field === field) {
    state.order = state.order === 'asc' ? 'desc' : 'asc';
  } else {
    state.field = field;
    state.order = field === 'name' || field === 'type' || field === 'token' ? 'asc' : 'desc';
  }

  applySortAndRender(reportType);
}

function renderReport(reportType) {
  const data = reportData[reportType];
  let html = '';
  let totalAmount = 0;
  let totalCount = 0;

  if (reportType === 'items') {
    data.forEach(item => {
      totalAmount += item.total;
      html += `
        <tr>
          <td>${item.name}</td>
          <td class="qty-cell">${item.qty}</td>
          <td class="amount-cell">₹${item.total.toLocaleString('en-IN')}</td>
        </tr>
      `;
    });
    if (data.length > 0) {
      html += `
        <tr class="report-total">
          <td><strong>TOTAL</strong></td>
          <td class="qty-cell"><strong>${data.reduce((s, i) => s + i.qty, 0)}</strong></td>
          <td class="amount-cell"><strong>₹${totalAmount.toLocaleString('en-IN')}</strong></td>
        </tr>
      `;
    }
  } else if (reportType === 'events') {
    data.forEach(event => {
      totalAmount += event.total;
      totalCount += event.count;
      html += `
        <tr>
          <td class="event-cell">${event.type}</td>
          <td class="qty-cell">${event.count}</td>
          <td class="amount-cell">₹${event.total.toLocaleString('en-IN')}</td>
        </tr>
      `;
    });
    if (data.length > 0) {
      html += `
        <tr class="report-total">
          <td><strong>TOTAL</strong></td>
          <td class="qty-cell"><strong>${totalCount}</strong></td>
          <td class="amount-cell"><strong>₹${totalAmount.toLocaleString('en-IN')}</strong></td>
        </tr>
      `;
    }
  } else if (reportType === 'bills') {
    // Pagination logic
    const totalBillsCount = data.length;
    const totalPages = Math.ceil(totalBillsCount / billsPerPage) || 1;
    const startIndex = (currentBillPage - 1) * billsPerPage;
    const endIndex = startIndex + billsPerPage;
    const billsToShow = data.slice(startIndex, endIndex);
    
    // Update page info
    const pageInfoEl = document.getElementById('billPageInfo');
    if (pageInfoEl) {
      pageInfoEl.textContent = totalBillsCount > 0 ? `(Page ${currentBillPage} of ${totalPages})` : '';
    }
    
    // Update navigation buttons
    const prevBtn = document.getElementById('prevBillPageBtn');
    const nextBtn = document.getElementById('nextBillPageBtn');
    if (prevBtn) prevBtn.disabled = currentBillPage === 1 || totalBillsCount === 0;
    if (nextBtn) nextBtn.disabled = currentBillPage >= totalPages || totalBillsCount === 0;
    
    billsToShow.forEach(bill => {
      totalAmount += bill.total;
      
      html += `
        <tr>
          <td class="bill-no-cell">${bill.token}</td>
          <td>${bill.date}</td>
          <td class="event-cell">${bill.orderType}</td>
          <td class="qty-cell">${bill.items}</td>
          <td class="amount-cell">₹${bill.total.toLocaleString('en-IN')}</td>
          <td>${bill.payment}</td>
        </tr>
      `;
    });
    if (billsToShow.length > 0) {
      html += `
        <tr class="report-total">
          <td colspan="5"><strong>SHOWING ${startIndex + 1}-${Math.min(endIndex, totalBillsCount)} of ${totalBillsCount} bills</strong></td>
          <td class="amount-cell"><strong>₹${totalAmount.toLocaleString('en-IN')}</strong></td>
        </tr>
      `;
    }
  }

  if (!html) {
    html = `<tr><td colspan="${reportType === 'bills' ? 7 : 3}" class="no-data">No data available</td></tr>`;
  }

  document.getElementById(reportType + 'ReportBody').innerHTML = html;
}

function changeBillPage(direction) {
  const totalPages = Math.ceil(reportData.bills.length / billsPerPage);
  const newPage = currentBillPage + direction;
  
  if (newPage >= 1 && newPage <= totalPages) {
    currentBillPage = newPage;
    renderReport('bills');
  }
}

function createChart(canvasId, type, data, options = {}) {
  const ctx = document.getElementById(canvasId);
  if (!ctx) return;

  // Destroy existing chart if it exists
  if (chartInstances[canvasId]) {
    chartInstances[canvasId].destroy();
  }

  // Default options for all charts
  const defaultOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        labels: {
          color: 'rgba(255, 255, 255, 0.8)',
          font: { size: 12 }
        }
      }
    },
    scales: {
      y: {
        ticks: { color: 'rgba(255, 255, 255, 0.6)' },
        grid: { color: 'rgba(255, 213, 79, 0.1)' }
      },
      x: {
        ticks: { color: 'rgba(255, 255, 255, 0.6)' },
        grid: { color: 'rgba(255, 213, 79, 0.1)' }
      }
    }
  };

  chartInstances[canvasId] = new Chart(ctx, {
    type: type,
    data: data,
    options: { ...defaultOptions, ...options }
  });
}

/* ===== CATEGORY ANALYSIS ===== */
let categoryData = {};
let selectedCategory = 'all';
let categoryMap = {};

function extractCategories() {
  // Extract categories from backend item data structure
  // Assuming items have a category field
  const categories = new Set();
  categoryMap = {};
  
  reportData.items.forEach(item => {
    let category = 'Other';
    const name = item.name.toLowerCase();
    
    // Map items to categories based on keywords
    if (name.includes('tiffin') || name.includes('idli') || name.includes('dosa') || name.includes('uttapam')) {
      category = 'Tiffins';
    } else if (name.includes('biryani') || name.includes('rice')) {
      category = 'Biryanis';
    } else if (name.includes('meal') || name.includes('combo') || name.includes('thali')) {
      category = 'Meals';
    } else if (name.includes('juice') || name.includes('shake') || name.includes('drink') || name.includes('beverage')) {
      category = 'Juice Bar';
    } else if (name.includes('starter') || name.includes('appetizer') || name.includes('spring roll')) {
      category = 'Starters';
    } else if (name.includes('noodles') || name.includes('manchurian') || name.includes('fried') || name.includes('chow')) {
      category = 'Fast Food';
    }
    
    categories.add(category);
    categoryMap[item.name] = category;
  });
  
  return Array.from(categories).sort();
}

function buildCategoryTabs() {
  const categories = extractCategories();
  let tabsHTML = '<button class="category-tab active" onclick="selectCategory(\'all\')" data-category="all">All Categories</button>';
  
  categories.forEach(category => {
    tabsHTML += `<button class="category-tab" onclick="selectCategory('${category}')" data-category="${category.replace(/'/g, "\\'")}"">${category}</button>`;
  });
  
  document.getElementById('categoryTabs').innerHTML = tabsHTML;
}

function calculateCategoryStats(category) {
  let stats = {
    revenue: 0,
    itemCount: 0,
    avgPrice: 0,
    billCount: 0,
    items: {}
  };
  
  if (category === 'all') {
    // All categories combined
    reportData.items.forEach(item => {
      stats.revenue += item.total || 0;
      stats.itemCount += item.qty || 0;
      stats.items[item.name] = {
        name: item.name,
        qty: item.qty,
        total: item.total,
        price: item.qty > 0 ? Math.round(item.total / item.qty) : 0
      };
    });
  } else {
    // Specific category
    reportData.items.forEach(item => {
      if (categoryMap[item.name] === category) {
        stats.revenue += item.total || 0;
        stats.itemCount += item.qty || 0;
        stats.items[item.name] = {
          name: item.name,
          qty: item.qty,
          total: item.total,
          price: item.qty > 0 ? Math.round(item.total / item.qty) : 0
        };
      }
    });
  }
  
  // Count bills that contain items from this category
  if (category === 'all') {
    stats.billCount = reportData.bills.length;
  } else {
    const categoryItems = Object.keys(categoryMap).filter(item => categoryMap[item] === category);
    stats.billCount = reportData.bills.filter(bill => {
      // Count bills that have at least one item from this category
      return true; // Simplified - count all bills for now
    }).length;
  }
  
  stats.avgPrice = stats.itemCount > 0 ? Math.round(stats.revenue / stats.itemCount) : 0;
  
  return stats;
}

function selectCategory(category) {
  selectedCategory = category;
  
  // Update active tab
  document.querySelectorAll('.category-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector(`[data-category="${category}"]`).classList.add('active');
  
  // Update category analysis display
  const stats = calculateCategoryStats(category);
  
  // Update header
  const title = category === 'all' ? 'All Categories' : category;
  document.getElementById('categoryTitle').textContent = title;
  document.getElementById('categoryItemCount').textContent = `${stats.itemCount} items sold`;
  
  // Update stats
  document.getElementById('catRevenue').textContent = stats.revenue.toLocaleString('en-IN');
  document.getElementById('catItemCount').textContent = stats.itemCount;
  document.getElementById('catAvgPrice').textContent = stats.avgPrice.toLocaleString('en-IN');
  document.getElementById('catBillCount').textContent = stats.billCount;
  
  // Build items grid
  let itemsHTML = '';
  Object.entries(stats.items).forEach(([name, itemStats]) => {
    itemsHTML += `
      <div class="category-item-card">
        <div class="item-card-name">${name}</div>
        <div class="item-card-details">
          <div class="item-card-detail">
            <strong>${itemStats.qty}</strong> units
          </div>
          <div class="item-card-detail">
            <strong>₹${itemStats.price}</strong> each
          </div>
          <div class="item-card-detail">
            <strong>₹${itemStats.total.toLocaleString('en-IN')}</strong> total
          </div>
        </div>
      </div>
    `;
  });
  
  document.getElementById('categoryItemsGrid').innerHTML = itemsHTML || '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #999;">No items in this category</div>';
  
  // Show/hide chart container based on category count
  const chartContainer = document.getElementById('categoryChartContainer');
  if (Object.keys(stats.items).length > 1 && category === 'all') {
    chartContainer.style.display = 'block';
    
    // Create category breakdown chart
    const catLabels = extractCategories();
    const catValues = catLabels.map(cat => {
      const catStats = calculateCategoryStats(cat);
      return catStats.revenue;
    });
    
    if (catValues.some(v => v > 0)) {
      createChart('categoryDetailChart', 'pie', {
        labels: catLabels,
        datasets: [{
          data: catValues,
          backgroundColor: [
            'rgba(255, 213, 79, 0.8)',
            'rgba(76, 175, 80, 0.8)',
            'rgba(33, 150, 243, 0.8)',
            'rgba(211, 47, 47, 0.8)',
            'rgba(255, 152, 0, 0.8)',
            'rgba(229, 57, 53, 0.8)',
            'rgba(66, 133, 244, 0.8)',
            'rgba(52, 168, 224, 0.8)'
          ],
          borderColor: [
            'rgba(255, 179, 0, 1)',
            'rgba(56, 142, 60, 1)',
            'rgba(13, 110, 253, 1)',
            'rgba(168, 27, 27, 1)',
            'rgba(230, 124, 0, 1)',
            'rgba(192, 34, 34, 1)',
            'rgba(29, 78, 216, 1)',
            'rgba(6, 182, 212, 1)'
          ],
          borderWidth: 2
        }]
      }, {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      });
    }
  } else {
    chartContainer.style.display = 'none';
  }
  
  // Show container
  document.getElementById('categoryAnalysisContainer').style.display = 'block';
}

/* ===== DATE SELECTION ===== */
let selectedDate = new Date();
selectedDate.setHours(0, 0, 0, 0);
let dateMode = 'today';
let rangeFromDate = null;
let rangeToDate = null;

function getLocalDateInputValue(date) {
  const local = new Date(date);
  local.setMinutes(local.getMinutes() - local.getTimezoneOffset());
  return local.toISOString().split('T')[0];
}

function setAnalyticsDate(mode) {
  dateMode = mode;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Update active button
  document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
  
  if (mode === 'today') {
    selectedDate = new Date(today);
    document.getElementById('btn-today').classList.add('active');
    document.getElementById('dateDisplay').textContent = 'Today (' + today.toLocaleDateString('en-IN') + ')';
    const customDateInput = document.getElementById('customDate');
    if (customDateInput) {
      customDateInput.value = getLocalDateInputValue(today);
    }
  } else if (mode === 'week') {
    selectedDate = new Date(today);
    selectedDate.setDate(selectedDate.getDate() - selectedDate.getDay());
    document.getElementById('btn-week').classList.add('active');
    document.getElementById('dateDisplay').textContent = 'This Week (Starting ' + selectedDate.toLocaleDateString('en-IN') + ')';
  } else if (mode === 'month') {
    selectedDate = new Date(today);
    selectedDate.setDate(1);
    document.getElementById('btn-month').classList.add('active');
    document.getElementById('dateDisplay').textContent = 'This Month (' + selectedDate.toLocaleDateString('en-IN', {month: 'long', year: 'numeric'}) + ')';
  } else if (mode === 'custom') {
    selectedDate = new Date(document.getElementById('customDate').value);
    selectedDate.setHours(0, 0, 0, 0);
    document.getElementById('dateDisplay').textContent = 'Custom Date (' + selectedDate.toLocaleDateString('en-IN') + ')';
  } else if (mode === 'range') {
    const fromInput = document.getElementById('rangeFrom');
    const toInput = document.getElementById('rangeTo');
    rangeFromDate = fromInput && fromInput.value ? new Date(fromInput.value + 'T00:00:00') : null;
    rangeToDate = toInput && toInput.value ? new Date(toInput.value + 'T23:59:59') : null;
    if (!rangeFromDate || !rangeToDate || isNaN(rangeFromDate.getTime()) || isNaN(rangeToDate.getTime())) {
      alert('Please select both From and To dates');
      return;
    }
    if (rangeFromDate > rangeToDate) {
      alert('From date must be before To date');
      return;
    }
    document.getElementById('btn-range').classList.add('active');
    const fromText = rangeFromDate.toLocaleDateString('en-IN');
    const toText = rangeToDate.toLocaleDateString('en-IN');
    document.getElementById('dateDisplay').textContent = 'Range (' + fromText + ' to ' + toText + ')';
  }
  
  // Reload analytics with selected date
  loadAnalytics();
}

function applyRangeFilter() {
  document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
  setAnalyticsDate('range');
}

/* ===== BILL SEARCH & DELETE ===== */
let pendingDeleteToken = null;

function searchBills(query) {
  const searchTerm = query.toLowerCase();
  const rows = document.querySelectorAll('#billsReportBody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    if (row.classList.contains('no-data')) return;
    
    const billNo = row.cells[0]?.textContent.toLowerCase() || '';
    const payment = row.cells[5]?.textContent.toLowerCase() || '';
    const orderType = row.cells[2]?.textContent.toLowerCase() || '';
    
    const matches = billNo.includes(searchTerm) || payment.includes(searchTerm) || orderType.includes(searchTerm);
    
    if (matches) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
  
  if (visibleCount === 0) {
    document.getElementById('billsReportBody').innerHTML = '<tr><td colspan="6" class="no-data">No bills match your search</td></tr>';
  }
}

/* ===== BILL ACTIONS MODAL ===== */
let currentActionMode = null;
let selectedBillToken = null;

function getBillNumber(bill) {
  return bill.token || bill.billNo || 0;
}

function sortBillsByNumberDesc(bills) {
  return [...bills].sort((a, b) => getBillNumber(b) - getBillNumber(a));
}

function getBillDateValue(bill) {
  const rawDate = bill.createdAt || bill.createdAtISO || bill.date || null;
  if (!rawDate) return null;
  const billDate = new Date(rawDate);
  if (isNaN(billDate.getTime())) return null;
  return billDate;
}

function filterBillsForCurrentDateMode(bills) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  if (dateMode === 'today') {
    return bills.filter(bill => {
      const billDate = getBillDateValue(bill);
      if (!billDate) return false;
      billDate.setHours(0, 0, 0, 0);
      return billDate.getTime() === today.getTime();
    });
  }

  if (dateMode === 'week') {
    const weekStart = new Date(today);
    weekStart.setDate(today.getDate() - today.getDay());
    return bills.filter(bill => {
      const billDate = getBillDateValue(bill);
      if (!billDate) return false;
      billDate.setHours(0, 0, 0, 0);
      return billDate.getTime() >= weekStart.getTime();
    });
  }

  if (dateMode === 'month') {
    const monthStart = new Date(today);
    monthStart.setDate(1);
    return bills.filter(bill => {
      const billDate = getBillDateValue(bill);
      if (!billDate) return false;
      billDate.setHours(0, 0, 0, 0);
      return billDate.getTime() >= monthStart.getTime();
    });
  }

  if (dateMode === 'custom' && selectedDate) {
    const customDate = new Date(selectedDate);
    customDate.setHours(0, 0, 0, 0);
    return bills.filter(bill => {
      const billDate = getBillDateValue(bill);
      if (!billDate) return false;
      billDate.setHours(0, 0, 0, 0);
      return billDate.getTime() === customDate.getTime();
    });
  }

  if (dateMode === 'range' && rangeFromDate && rangeToDate) {
    const fromDate = new Date(rangeFromDate);
    const toDate = new Date(rangeToDate);
    return bills.filter(bill => {
      const billDate = getBillDateValue(bill);
      if (!billDate) return false;
      return billDate >= fromDate && billDate <= toDate;
    });
  }

  return bills;
}

function openBillActionsModal() {
  // Check if user is admin
  const userData = localStorage.getItem('user');
  if (userData) {
    try {
      const user = JSON.parse(userData);
      if (user.role !== 'admin') {
        alert('Access denied. Only administrators can manage bills.');
        return;
      }
    } catch (e) {
      alert('Authentication error. Please login again.');
      return;
    }
  } else {
    alert('Please login to access this feature.');
    return;
  }
  
  document.getElementById('billActionsModal').classList.add('active');
  currentActionMode = null;
  document.getElementById('actionModeContent').style.display = 'none';
  document.getElementById('billSelector').innerHTML = '<option value="">-- Select a bill --</option>';
}

function closeBillActionsModal() {
  document.getElementById('billActionsModal').classList.remove('active');
  currentActionMode = null;
  selectedBillToken = null;
  document.getElementById('actionModeContent').style.display = 'none';
}

function switchActionMode(mode) {
  currentActionMode = mode;
  selectedBillToken = null;
  document.getElementById('actionModeContent').style.display = 'block';
  
  const billSelector = document.getElementById('billSelector');
  const actionWarning = document.getElementById('actionWarning');
  const confirmBtn = document.getElementById('confirmActionBtn');
  
  billSelector.innerHTML = '<option value="">-- Select a bill --</option>';
  confirmBtn.disabled = false;
  actionWarning.style.display = 'none';
  
  if (mode === 'hide') {
    confirmBtn.textContent = 'Hide Bill';
    confirmBtn.className = 'delete-confirm-btn';
    confirmBtn.style.background = 'linear-gradient(135deg, #2196f3 0%, #1976d2 100%)';
    actionWarning.innerHTML = '⚠️ The selected bill will be hidden from analytics but can be restored later.';
    actionWarning.style.display = 'block';
    actionWarning.style.background = 'rgba(33, 150, 243, 0.15)';
    actionWarning.style.borderLeft = '3px solid #2196f3';
    
    // Load active bills (not deleted)
    const activeBills = sortBillsByNumberDesc(reportData.bills.filter(bill => !bill.deleted));
    if (activeBills.length === 0) {
      billSelector.innerHTML = '<option value="">-- No active bills to hide --</option>';
      billSelector.disabled = true;
      confirmBtn.disabled = true;
    } else {
      activeBills.forEach(bill => {
        const option = document.createElement('option');
        option.value = bill.token;
        option.textContent = `Bill #${bill.token} - ₹${bill.total.toLocaleString('en-IN')} (${bill.date})`;
        billSelector.appendChild(option);
      });
      billSelector.disabled = false;
    }
  } else if (mode === 'unhide') {
    confirmBtn.textContent = 'Unhide Bill';
    confirmBtn.className = 'delete-confirm-btn';
    confirmBtn.style.background = 'linear-gradient(135deg, #4caf50 0%, #388e3c 100%)';
    actionWarning.innerHTML = '✓ The selected bill will be restored and shown in analytics again.';
    actionWarning.style.display = 'block';
    actionWarning.style.background = 'rgba(76, 175, 80, 0.15)';
    actionWarning.style.borderLeft = '3px solid #4caf50';
    
    // Fetch hidden bills from API
    billSelector.innerHTML = '<option value="">Loading hidden bills...</option>';
    billSelector.disabled = true;
    confirmBtn.disabled = true;
    
    fetch(apiUrl('/api/bills?includeDeleted=true'))
      .then(res => res.json())
      .then(bills => {
        const hiddenBills = bills.filter(bill => bill.deleted === true || bill.deleted);
        billSelector.innerHTML = '<option value="">-- Select a bill --</option>';
        
        if (hiddenBills.length === 0) {
          billSelector.innerHTML = '<option value="">-- No hidden bills available --</option>';
          billSelector.disabled = true;
          confirmBtn.disabled = true;
        } else {
          sortBillsByNumberDesc(hiddenBills).forEach(bill => {
            const option = document.createElement('option');
            option.value = getBillNumber(bill);
            const billDate = bill.date || new Date(bill.createdAt).toLocaleDateString('en-IN');
            option.textContent = `Bill #${getBillNumber(bill)} - ₹${bill.total.toLocaleString('en-IN')} (${billDate})`;
            billSelector.appendChild(option);
          });
          billSelector.disabled = false;
          confirmBtn.disabled = false;
        }
      })
      .catch(err => {
        billSelector.innerHTML = '<option value="">Error loading bills</option>';
        billSelector.disabled = true;
        confirmBtn.disabled = true;
      });
  } else if (mode === 'delete') {
    confirmBtn.textContent = 'Permanently Delete';
    confirmBtn.className = 'permanent-delete-btn';
    confirmBtn.style.background = 'linear-gradient(135deg, #d32f2f 0%, #c62828 100%)';
    actionWarning.innerHTML = '⛔ WARNING: This will permanently delete the bill from the database. This action CANNOT BE UNDONE!';
    actionWarning.style.display = 'block';
    actionWarning.style.background = 'rgba(211, 47, 47, 0.3)';
    actionWarning.style.borderLeft = '3px solid #ff6b6b';
    
    // Fetch all bills (both hidden and unhidden) from API
    billSelector.innerHTML = '<option value="">Loading all bills...</option>';
    billSelector.disabled = true;
    confirmBtn.disabled = true;
    
    fetch(apiUrl('/api/bills?includeDeleted=true'))
      .then(res => res.json())
      .then(allBills => {
        const filteredBills = filterBillsForCurrentDateMode(allBills);
        billSelector.innerHTML = '<option value="">-- Select a bill --</option>';

        if (filteredBills.length === 0) {
          billSelector.innerHTML = '<option value="">-- No bills for selected date --</option>';
          billSelector.disabled = true;
          confirmBtn.disabled = true;
        } else {
          sortBillsByNumberDesc(filteredBills).forEach(bill => {
            const option = document.createElement('option');
            const status = bill.deleted ? '(Hidden)' : '(Active)';
            option.value = getBillNumber(bill);
            const billDate = bill.date || new Date(bill.createdAt).toLocaleDateString('en-IN');
            option.textContent = `Bill #${getBillNumber(bill)} - ₹${bill.total.toLocaleString('en-IN')} ${status}`;
            billSelector.appendChild(option);
          });
          billSelector.disabled = false;
          confirmBtn.disabled = false;
        }
      })
      .catch(err => {
        billSelector.innerHTML = '<option value="">Error loading bills</option>';
        billSelector.disabled = true;
        confirmBtn.disabled = true;
      });
  }
}

function confirmBillAction() {
  const billSelector = document.getElementById('billSelector');
  selectedBillToken = parseInt(billSelector.value);
  
  if (!selectedBillToken || selectedBillToken === 0 || isNaN(selectedBillToken)) {
    alert('Please select a bill');
    return;
  }
  
  if (currentActionMode === 'hide') {
    hideBill(selectedBillToken);
  } else if (currentActionMode === 'unhide') {
    unhideBill(selectedBillToken);
  } else if (currentActionMode === 'delete') {
    showPermanentDeleteConfirm(selectedBillToken);
  }
  
  closeBillActionsModal();
}

function toggleHiddenBills() {
  showingHiddenBills = !showingHiddenBills;
  const btn = document.getElementById('toggleHiddenBtn');
  
  if (showingHiddenBills) {
    btn.textContent = 'Show Active Bills';
    btn.classList.add('active');
  } else {
    btn.textContent = 'Show Hidden Bills';
    btn.classList.remove('active');
  }
  
  loadAnalytics();
}

function toggleAllBills() {
  showingAllBills = !showingAllBills;
  const btn = document.getElementById('toggleAllBillsBtn');
  
  if (showingAllBills) {
    btn.textContent = 'Show Top 50';
    btn.style.background = 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)';
  } else {
    btn.textContent = 'Show All';
    btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #388e3c 100%)';
  }
  
  renderReport('bills');
}

/* ===== DOWNLOAD ANALYTICS ===== */
function downloadAnalytics() {
  try {
    // Group bills by day
    const billsByDay = {};
    reportData.bills.forEach(bill => {
      const date = bill.date ? bill.date.split(' ')[0] : new Date().toISOString().slice(0, 10);
      if (!billsByDay[date]) {
        billsByDay[date] = [];
      }
      billsByDay[date].push(bill);
    });

    // Prepare CSV
    let csvContent = 'SVFC Chinese Kitchen - Daily Sales Report\n';
    csvContent += `Generated: ${new Date().toLocaleString('en-IN')}\n\n`;
    
    // Daily summary table
    csvContent += 'SI.NO,Date,Bills Generated,Total Amount (₹),Cash / UPI,Card,Average Bill (₹)\n';
    
    let siNo = 1;
    let grandTotal = 0;
    let grandCashUPI = 0, grandCard = 0;
    let totalBills = 0;
    
    // Sort dates
    const sortedDates = Object.keys(billsByDay).sort();
    
    sortedDates.forEach(date => {
      const dayBills = billsByDay[date].filter(b => !b.deleted);
      if (dayBills.length === 0) return;
      
      let dayTotal = 0;
      let cashUPI = 0, card = 0;
      
      dayBills.forEach(bill => {
        dayTotal += bill.total || 0;
        const payment = bill.payment || 'Unknown';
        // Handle both old format and new combined format
        if (payment === 'Cash / UPI' || payment === 'Cash' || payment === 'Cash/UPI' || payment === 'UPI') {
          cashUPI += bill.total || 0;
        } else if (payment === 'Card') {
          card += bill.total || 0;
        }
      });
      
      const avgBill = dayBills.length > 0 ? Math.round(dayTotal / dayBills.length) : 0;
      
      csvContent += `${siNo},${date},${dayBills.length},${dayTotal},${cashUPI},${card},${avgBill}\n`;
      
      grandTotal += dayTotal;
      grandCashUPI += cashUPI;
      grandCard += card;
      totalBills += dayBills.length;
      siNo++;
    });
    
    // Total row
    const grandAvg = totalBills > 0 ? Math.round(grandTotal / totalBills) : 0;
    csvContent += `TOTAL,,${totalBills},${grandTotal},${grandCashUPI},${grandCard},${grandAvg}\n\n`;
    
    // Payment breakdown summary
    csvContent += 'PAYMENT METHOD BREAKDOWN\n';
    csvContent += 'Payment Method,Amount (₹),Count\n';
    
    const paymentBreakdown = {};
    reportData.bills.filter(b => !b.deleted).forEach(bill => {
      let method = bill.payment || 'Unknown';
      // Normalize payment methods to match index.html structure
      if (method === 'Cash / UPI' || method === 'Cash' || method === 'Cash/UPI' || method === 'UPI') {
        method = 'Cash / UPI';
      } else if (method === 'Card') {
        method = 'Card';
      }
      
      if (!paymentBreakdown[method]) {
        paymentBreakdown[method] = { amount: 0, count: 0 };
      }
      paymentBreakdown[method].amount += bill.total || 0;
      paymentBreakdown[method].count++;
    });
    
    Object.entries(paymentBreakdown).forEach(([method, data]) => {
      csvContent += `${method},${data.amount},${data.count}\n`;
    });
    csvContent += `\nGRAND TOTAL,${grandTotal}\n`;
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    const fileName = `svfc-chinese-kitchen-report_${new Date().toISOString().slice(0, 10)}.csv`;
    link.setAttribute('href', url);
    link.setAttribute('download', fileName);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } catch (error) {
    alert('Error downloading analytics: ' + error.message);
  }
}

/* ===== DOWNLOAD WITH DATE RANGE ===== */
function downloadAnalyticsWithRange() {
  try {
    const fromDate = document.getElementById('downloadFromDate').value;
    const toDate = document.getElementById('downloadToDate').value;
    
    if (!fromDate || !toDate) {
      alert('Please select both From Date and To Date');
      return;
    }
    
    const from = new Date(fromDate + 'T00:00:00');
    const to = new Date(toDate + 'T23:59:59');
    
    if (from > to) {
      alert('From Date must be before To Date');
      return;
    }
    
    // Filter bills within date range
    const sourceBills = allBillsData.length ? allBillsData : reportData.bills;
    const filteredBills = sourceBills.filter(bill => {
      const rawDate = bill.createdAt || bill.createdAtISO || bill.date;
      const billDate = rawDate ? new Date(rawDate) : null;
      if (!billDate || isNaN(billDate.getTime())) {
        return false;
      }
      return billDate >= from && billDate <= to && !bill.deleted;
    });
    
    if (filteredBills.length === 0) {
      alert('No bills found in the selected date range');
      return;
    }
    
    // Group bills by day
    const billsByDay = {};
    filteredBills.forEach(bill => {
      const billDate = new Date(bill.createdAt || bill.createdAtISO || bill.date);
      const date = billDate.toISOString().slice(0, 10);
      if (!billsByDay[date]) {
        billsByDay[date] = [];
      }
      billsByDay[date].push(bill);
    });
    
    // Prepare CSV
    let csvContent = 'SVFC Chinese Kitchen - Daily Sales Report (Custom Date Range)\n';
    csvContent += `Report Date: ${new Date().toLocaleString('en-IN')}\n`;
    csvContent += `Period: ${fromDate} to ${toDate}\n\n`;
    
    // Daily summary table
    csvContent += 'SI.NO,Date,Bills Generated,Total Amount (₹),Cash / UPI,Card,Average Bill (₹)\n';
    
    let siNo = 1;
    let grandTotal = 0;
    let grandCashUPI = 0, grandCard = 0;
    let totalBills = 0;
    
    // Sort dates
    const sortedDates = Object.keys(billsByDay).sort();
    
    sortedDates.forEach(date => {
      const dayBills = billsByDay[date];
      
      let dayTotal = 0;
      let cashUPI = 0, card = 0;
      
      dayBills.forEach(bill => {
        dayTotal += bill.total || 0;
        const payment = bill.payment || 'Unknown';
        // Handle both old format and new combined format
        if (payment === 'Cash / UPI' || payment === 'Cash' || payment === 'Cash/UPI' || payment === 'UPI') {
          cashUPI += bill.total || 0;
        } else if (payment === 'Card') {
          card += bill.total || 0;
        }
      });
      
      const avgBill = dayBills.length > 0 ? Math.round(dayTotal / dayBills.length) : 0;
      
      csvContent += `${siNo},${date},${dayBills.length},${dayTotal},${cashUPI},${card},${avgBill}\n`;
      
      grandTotal += dayTotal;
      grandCashUPI += cashUPI;
      grandCard += card;
      totalBills += dayBills.length;
      siNo++;
    });
    
    // Total row
    const grandAvg = totalBills > 0 ? Math.round(grandTotal / totalBills) : 0;
    csvContent += `TOTAL,,${totalBills},${grandTotal},${grandCashUPI},${grandCard},${grandAvg}\n\n`;
    
    // Payment breakdown summary
    csvContent += 'PAYMENT METHOD BREAKDOWN\n';
    csvContent += 'Payment Method,Amount (₹),Count\n';
    
    const paymentBreakdown = {};
    filteredBills.forEach(bill => {
      let method = bill.payment || 'Unknown';
      // Normalize payment methods to match index.html structure
      if (method === 'Cash / UPI' || method === 'Cash' || method === 'Cash/UPI' || method === 'UPI') {
        method = 'Cash / UPI';
      } else if (method === 'Card') {
        method = 'Card';
      }
      
      if (!paymentBreakdown[method]) {
        paymentBreakdown[method] = { amount: 0, count: 0 };
      }
      paymentBreakdown[method].amount += bill.total || 0;
      paymentBreakdown[method].count++;
    });
    
    Object.entries(paymentBreakdown).forEach(([method, data]) => {
      csvContent += `${method},${data.amount},${data.count}\n`;
    });
    csvContent += `\nGRAND TOTAL,${grandTotal}\n`;
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    const fileName = `svfc-chinese-kitchen-report_${fromDate}_to_${toDate}.csv`;
    link.setAttribute('href', url);
    link.setAttribute('download', fileName);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('Report downloaded successfully!');
  } catch (error) {
    alert('Error downloading report: ' + error.message);
  }
}

/* ===== HIDE/UNHIDE BILL ===== */
async function hideBill(billToken) {
  try {
    const token = localStorage.getItem('authToken') || localStorage.getItem('token');
    const response = await fetch(apiUrl(`/api/bill/${billToken}/delete`), {
      method: 'PUT',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      }
    });

    if (response.ok) {
      loadAnalytics();
    } else {
      alert('Failed to hide bill');
    }
  } catch (error) {
    alert('Error hiding bill: ' + error.message);
  }
}

async function unhideBill(billToken) {
  try {
    const token = localStorage.getItem('authToken') || localStorage.getItem('token');
    const response = await fetch(apiUrl(`/api/bill/${billToken}/restore`), {
      method: 'PUT',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      }
    });

    if (response.ok) {
      loadAnalytics();
    } else {
      alert('Failed to unhide bill');
    }
  } catch (error) {
    alert('Error unhiding bill: ' + error.message);
  }
}

/* ===== PERMANENT DELETE ===== */
let pendingPermanentDeleteToken = null;

function showPermanentDeleteConfirm(billToken) {
  pendingPermanentDeleteToken = billToken;
  document.getElementById('permDeleteBillNumber').textContent = billToken;
  document.getElementById('permanentDeleteModal').classList.add('active');
}

function cancelPermanentDelete() {
  pendingPermanentDeleteToken = null;
  document.getElementById('permanentDeleteModal').classList.remove('active');
}

async function confirmPermanentDelete() {
  if (!pendingPermanentDeleteToken) return;
  
  try {
    const token = localStorage.getItem('authToken') || localStorage.getItem('token');
    const response = await fetch(apiUrl(`/api/bill/${pendingPermanentDeleteToken}/permanent-delete`), {
      method: 'DELETE',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (response.ok) {
      document.getElementById('permanentDeleteModal').classList.remove('active');
      pendingPermanentDeleteToken = null;
      loadAnalytics();
    } else {
      alert('Failed to permanently delete bill');
    }
  } catch (error) {
    alert('Error permanently deleting bill: ' + error.message);
  }
}
// Check user role and hide admin-only features for cashiers
function checkUserRoleAndAdjustUI() {
  const userData = localStorage.getItem('user');
  if (userData) {
    try {
      const user = JSON.parse(userData);
      if (user.role === 'cashier') {
        // Hide manage bills button for cashiers
        const billActionsBtn = document.getElementById('billActionsBtn');
        if (billActionsBtn) {
          billActionsBtn.style.display = 'none';
        }
      }
    } catch (e) {
    }
  }
}

window.addEventListener('DOMContentLoaded', function() {
  checkUserRoleAndAdjustUI();
  loadAnalytics();
  
  // Initialize download date range with today's date
  const today = getLocalDateInputValue(new Date());
  const customDateInput = document.getElementById('customDate');
  const rangeFromInput = document.getElementById('rangeFrom');
  const rangeToInput = document.getElementById('rangeTo');
  const downloadFromDate = document.getElementById('downloadFromDate');
  const downloadToDate = document.getElementById('downloadToDate');
  if (customDateInput) customDateInput.value = today;
  if (rangeFromInput) rangeFromInput.value = today;
  if (rangeToInput) rangeToInput.value = today;
  if (downloadFromDate) downloadFromDate.value = today;
  if (downloadToDate) downloadToDate.value = today;
  
  // Add search listener
  const billSearch = document.getElementById('billSearch');
  if (billSearch) {
    billSearch.addEventListener('keyup', function() {
      searchBills(this.value);
    });
  }
});
</script>

<div style="background: linear-gradient(135deg, rgba(76,175,80,0.1) 0%, rgba(76,175,80,0.05) 100%); border-top: 2px solid #4caf50; border-left: 4px solid #4caf50; padding: 20px 25px; margin-top: 40px; margin-bottom: 20px; border-radius: 4px;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <h3 style="color: #4caf50; font-size: 13px; font-weight: 700; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; margin: 0 0 16px 0;">Download Analytics Report</h3>
    <div style="display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px;">
      <div style="display: flex; flex-direction: column; gap: 6px;">
        <label style="color: #ffd54f; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">From Date</label>
        <input type="date" id="downloadFromDate" class="custom-date-input" style="min-width: 140px; padding: 10px 12px; padding-right: 30px; font-size: 14px;">
      </div>
      <div style="display: flex; flex-direction: column; gap: 6px;">
        <label style="color: #ffd54f; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">To Date</label>
        <input type="date" id="downloadToDate" class="custom-date-input" style="min-width: 140px; padding: 10px 12px; padding-right: 30px; font-size: 14px;">
      </div>
      <button class="toggle-hidden-btn" id="downloadBtn" onclick="downloadAnalyticsWithRange()" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3); min-width: 160px; padding: 10px 20px; font-weight: 600; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; border: none; color: white; cursor: pointer; border-radius: 4px; transition: all 0.3s ease;">Download Report</button>
    </div>
  </div>
</div>

<footer class="page-footer" role="contentinfo">
  <b>© ANITS 2023–2027 CSE 88 DEV</b>
</footer>

</body>
</html>
